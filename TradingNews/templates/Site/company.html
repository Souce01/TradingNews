{% extends 'Site/base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}{{ company.Symbol }}{% endblock %}

{% block scripts %}
    <script src="{% static 'Site/company.js' %}"></script>
    <script src="{% static 'Site/articles.js' %}"></script>
    <script>
        $("#follow-button").on("click", function(e){
            fetch("{% url 'Site:api-follow' %}",{
                method: "POST",
                credentials: 'include',
                mode: 'same-origin',
                headers: {
                    "Accept": "application/json",
                    "Content-Type": "application/json",
                    'X-CSRFToken': "{{ csrf_token }}"
                },
                body: JSON.stringify({ symbol: "{{ company.Symbol }}" })
            }).then(resp => {
                if (!resp.ok) {
                    throw Error(resp.statusText);
                }
                return resp;
            }).then(resp => {
                return resp.json();
            }).then(data => {
                if (data['followed']){
                    $('#follow-button').removeClass('not-followed').addClass('followed');
                    $('#follow-button').text("followed");
                } else{
                    $('#follow-button').removeClass('followed').addClass('not-followed');
                    $('#follow-button').text("follow");
                }
            }).catch(err =>{
                console.error(err);
            })
        })
    </script>
{% endblock %}

{% block content %}
    <div class="content">
        <div class="col-1">
            <!-- company profile -->
            <div class="profile-container">
                <div class="profile-header-container">
                    <div class="profile-header">
                        <div>{{ company.Name }}</div>
                        <div>{{ company.Symbol }} &#8226 {{ company.Exchange }}</div>
                    </div>
                    {% if user.is_authenticated %}
                        <div id="follow-button">follow</div>
                    {% endif %}
                </div>
                <div class="profile-content-container">
                    <div class="profile-info-container">
                        <div class="profile-price-container">
                            <div class="profile-price">{{ endPoint|get:"05. price"|decimalLimit:3 }}</div>
                            {% if endPoint|get:"09. change"|first == '-' %}
                                <div class="profile-price-change red">{{ endPoint|get:"09. change"|decimalLimit }} ({{ endPoint|get:"10. change percent" }})</div>
                            {% else %}
                                <div class="profile-price-change green">+{{ endPoint|get:"09. change"|decimalLimit }} ({{ endPoint|get:"10. change percent" }})</div>
                            {% endif %}
                        </div>
                        <div class="profile-info">
                            <div class="profile-info-col">
                                <div class="profile-info-element">
                                    <div>Previous close</div>
                                    <div>{{ endPoint|get:"08. previous close"|decimalLimit }}</div>
                                </div>
                                <div class="profile-info-element">
                                    <div>Open</div>
                                    <div>{{ endPoint|get:"02. open"|decimalLimit }}</div>
                                </div>
                                <div class="profile-info-element">
                                    <div>Day's range</div>
                                    <div>{{ endPoint|get:"04. low"|decimalLimit }} - {{ endPoint|get:"03. high"|decimalLimit }}</div>
                                </div>
                                <div class="profile-info-element">
                                    <div>52 week range</div>
                                    <div>{{ company.52WeekLow|decimalLimit }} - {{ company.52WeekHigh|decimalLimit }}</div>
                                </div>
                                <div class="profile-info-element">
                                    <div>Dividend Yield</div>
                                    <div>{{ company.DividendYield|percentage }}</div>
                                </div>
                            </div>
                            <div class="profile-info-col">
                                <div class="profile-info-element">
                                    <div>Market cap</div>
                                    <div>{{ company.MarketCapitalization|commas }}</div>
                                </div>
                                <div class="profile-info-element">
                                    <div>Volume</div>
                                    <div>{{ endPoint|get:"06. volume"|commas }}</div>
                                </div>
                                <div class="profile-info-element">
                                    <div>PE Ratio</div>
                                    <div>{{ company.PERatio|decimalLimit }}</div>
                                </div>
                                <div class="profile-info-element">
                                    <div>Forward PE</div>
                                    <div>{{ company.ForwardPE|decimalLimit }}</div>
                                </div>
                                <div class="profile-info-element">
                                    <div>EPS</div>
                                    <div>{{ company.EPS|decimalLimit }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="profile-chart-container">
                        <div class="profile-chart-button-container">
                            <div id="profile-chart-button-5m" class="profile-chart-button">5m</div>
                            <div id="profile-chart-button-15m" class="profile-chart-button">15m</div>
                            <div id="profile-chart-button-30m" class="profile-chart-button">30m</div>
                            <div id="profile-chart-button-60m" class="profile-chart-button">60m</div>
                        </div>
                        <canvas id="chart" class="profile-chart">
                        </canvas>
                    </div>
                </div>
            </div>
            {% include 'Site/article.html' %}
        </div>
        <div class="col-2">
            <div class="watchlist-container"></div>
        </div>
    </div>
{% endblock %}